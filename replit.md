# 受発注見込み入力／月次突合 Webシステム

## プロジェクト概要

Excel相当以上の入力体験とGL（総勘定元帳）との月次突合を半自動化するWebシステムのモックアップ実装。

### 主要機能

#### 1. Excel風データグリッド入力
- **キーボードナビゲーション**: Tab/Shift+Tab（セル移動）、Enter（編集/確定）、矢印キー
- **高速編集操作**: ダブルクリックまたはEnterで編集開始
- **リアルタイムバリデーション**: 入力値の即時チェック
- **オートコンプリート**: 取引先・品目マスタからのインクリメンタルサーチ

#### 2. キーボードショートカット
- `Ctrl + Enter`: 一括保存
- `Ctrl + Shift + ↓`: 行追加
- `Ctrl + Shift + Del`: 選択行削除
- `Ctrl + Shift + D`: 行複製
- `Ctrl + F`: 検索（モック）
- `Alt + 0`: 列レイアウト初期化（予定）

#### 3. GL突合機能
- **厳格突合**: 伝票No + 日付 + 金額での完全一致
- **ファジー突合**: 日付±3日 + 金額での柔軟な突合
- **ステータス表示**: 
  - 🟢 突合済（matched）
  - 🟡 曖昧一致（fuzzy）
  - 🔴 未突合（unmatched）
- **突合パネル**: リアルタイムの突合状況確認、未突合データの一覧表示

#### 4. その他機能
- **期間管理**: 月次（YYYY-MM形式）での データフィルタリング
- **ダークモード対応**: ライト/ダークテーマ切替
- **レスポンシブデザイン**: 各種画面サイズに対応

## 技術スタック

### フロントエンド
- **React 18** + **TypeScript**: UI構築
- **Vite**: ビルドツール
- **Wouter**: 軽量ルーティング
- **TanStack Query**: データフェッチング・キャッシュ管理
- **Shadcn/ui**: UIコンポーネント
- **Tailwind CSS**: スタイリング
- **react-hotkeys-hook**: キーボードショートカット
- **Zod**: スキーマバリデーション

### バックエンド（モック実装）
- **Node.js + Express**: サーバー
- **In-memory Storage**: メモリ内データ管理（ダミーCRUD）
- **Drizzle ORM**: 型定義・スキーマ管理
- **Zod**: サーバーサイドバリデーション

### バックエンドアーキテクチャ（2025-10-06更新）
- **責務分離型構造**: 機能ベースのリポジトリパターン採用
- **ミドルウェア層**: グローバル・ルート固有に分離
  - `server/middleware/`: 認証、セキュリティ、CSRF、ファイルアップロード、ロギング
  - `server/routes/middleware/`: ルート固有のバリデーション（今後実装予定）
- **データアクセス層**: 7機能別リポジトリ構成
  ```
  server/storage/
  ├─ index.ts (統合インターフェース)
  ├─ orderForecast/ (受発注見込み)
  ├─ glEntry/ (GL総勘定元帳)
  ├─ customer/ (取引先マスタ)
  ├─ item/ (品目マスタ)
  ├─ project/ (プロジェクトマスタ)
  ├─ accountingItem/ (勘定科目マスタ)
  └─ reconciliation/ (突合ログ)
  ```
- **各リポジトリ構成**: `XxxRepository.ts`, `types.ts`, `index.ts`
- **JSDoc完備**: 各リポジトリがアクセスするテーブル名を明記

## アーキテクチャ

### データモデル
```
customers (取引先マスタ)
  ├─ id, code, name
  
items (品目マスタ)
  ├─ id, code, name
  
orderForecasts (受発注データ)
  ├─ id, voucherNo, orderDate
  ├─ customer関連 (customerId, code, name)
  ├─ item関連 (itemId, code, name)
  ├─ quantity, unitPrice, amount
  ├─ reconciliationStatus (matched/fuzzy/unmatched)
  └─ glMatchId (突合先GL ID)
  
glEntries (GLデータ)
  ├─ id, voucherNo, transactionDate
  ├─ accountCode, accountName
  ├─ amount, debitCredit
  ├─ reconciliationStatus
  └─ orderMatchId (突合先受発注ID)
```

### コンポーネント構成
```
App.tsx
├─ SidebarProvider
│   ├─ AppSidebar (サイドバーメニュー)
│   │   ├─ 分析系
│   │   │   ├─ ダッシュボード (/)
│   │   │   ├─ プロジェクト分析 (/project-analysis)
│   │   │   └─ GL突合 (/gl-reconciliation) ★NEW
│   │   ├─ 入力系
│   │   │   ├─ 受発注見込み入力 (/order-forecast)
│   │   │   ├─ 要員山積み登録 (/staffing)
│   │   │   ├─ 角度B案件登録 (/angle-b)
│   │   │   └─ 予算登録 (/budget)
│   │   └─ マスタ系
│   │       ├─ 年度別プロジェクトマスタ (/projects)
│   │       └─ 取引先マスタ (/customers)
│   └─ Router (メインコンテンツ)
│
├─ OrderForecastPage (受発注見込み入力)
│   ├─ AdvancedFilterPanel (年度・月・プロジェクト選択)
│   ├─ ExcelDataGrid (メイングリッド)
│   │   ├─ AutocompleteSelect (取引先・品目選択)
│   │   └─ キーボードショートカット統合
│   ├─ GLReconciliationPanel (突合パネル)
│   │   └─ ReconciliationStatusBadge
│   └─ KeyboardShortcutsPanel (ショートカットヘルプ)
│
├─ GLReconciliationPage (GL突合専用ページ) ★NEW
│   ├─ フィルタパネル（年度・月選択）
│   ├─ 統計カード（突合率、突合済、曖昧一致、未突合）
│   ├─ 突合実行ボタン（厳格突合、ファジー突合）
│   ├─ タブ切替（全て、突合済、曖昧一致、未突合、未突合GL）
│   └─ データテーブル（受発注データ・GLデータ）
│
└─ CustomersPage (取引先マスタ) ★NEW
    ├─ 取引先一覧テーブル（コード、名称、作成日時、操作）
    ├─ 新規作成ダイアログ
    ├─ 編集ダイアログ
    ├─ 削除確認ダイアログ
    └─ CSVインポートダイアログ（テンプレートDL機能付き）
```

## 開発状況

### ✅ 完了した機能
- [x] サイドバーメニューシステム（3カテゴリ・9メニュー項目）
- [x] 多段階フィルタシステム（年度・月・プロジェクト）
- [x] Excel風データグリッドコンポーネント
- [x] キーボードナビゲーション（Tab, Enter, 矢印キー）
- [x] キーボードショートカット（Ctrl+Enter, Ctrl+Shift+↓など）
- [x] オートコンプリート選択（取引先・品目）
- [x] GL突合パネル（厳格・ファジーマッチング）
- [x] GL突合専用ページ（分析系メニュー）
- [x] 取引先マスタ管理画面（CRUD + CSVインポート）
- [x] ステータスバッジ・可視化
- [x] ダークモード対応
- [x] レスポンシブデザイン

### 🚧 今後の実装予定（Next Phase）
- [ ] PWA対応（オフライン編集）
- [ ] IndexedDB統合（ローカル下書き保存）
- [ ] データインポート/エクスポート（Excel/CSV）
- [ ] 監査ログ・操作履歴
- [ ] 高度な突合ロジック（AI支援）
- [ ] ユーザー権限管理・承認ワークフロー

## 使い方

### 起動方法
```bash
npm run dev
```

### 基本操作

#### 受発注見込み入力ページ
1. **期間選択**: ヘッダーの期間セレクターで対象月を選択
2. **データ入力**:
   - セルをダブルクリックまたはEnterで編集開始
   - Tab/Shift+Tabでセル移動
   - 取引先・品目はオートコンプリートから選択
3. **行操作**:
   - `Ctrl+Shift+↓`: 新規行追加
   - `Ctrl+Shift+D`: 現在行を複製
   - チェックボックス選択後、`Ctrl+Shift+Del`: 行削除
4. **保存**: `Ctrl+Enter`で一括保存
5. **GL突合（パネル内）**:
   - 「GL突合」ボタンをクリック
   - 厳格突合またはファジー突合を実行
   - 突合結果を確認

#### GL突合専用ページ（分析系メニュー）
1. **アクセス**: サイドバーの「分析系 > GL突合」をクリック
2. **フィルタ設定**:
   - 年度セレクターで対象年度を選択
   - 月セレクターで対象月を選択（「全て」で全月表示）
3. **突合実行**:
   - 「厳格突合実行」: 完全一致での突合
   - 「ファジー突合実行」: 日付±3日での柔軟な突合
4. **データ確認**:
   - タブ切替で各ステータスのデータを確認
   - 統計カードで突合状況を可視化

#### 取引先マスタページ（マスタ系メニュー）
1. **アクセス**: サイドバーの「マスタ系 > 取引先マスタ」をクリック
2. **取引先管理**:
   - 「新規作成」: 取引先コード・名称を入力して作成
   - 「編集」: 既存取引先の情報を更新
   - 「削除」: 取引先を削除（確認ダイアログあり）
3. **CSVインポート**:
   - 「CSVインポート」ボタンをクリック
   - 「テンプレートDL」で形式確認
   - CSVデータを入力してインポート
   - フォーマット: `code,name` (ヘッダー行 + データ行)

### キーボードショートカット
右上のキーボードアイコンをクリックすると、全ショートカット一覧を表示

## デザインガイドライン

詳細は `design_guidelines.md` を参照

### カラーパレット
- **Primary**: Blue (217 91% 60%) - アクション・フォーカス
- **Success**: Green (142 71% 45%) - 突合済
- **Warning**: Orange (38 92% 50%) - 曖昧一致
- **Destructive**: Red (0 84% 60%) - 未突合・エラー

### タイポグラフィ
- **UI**: Inter
- **数値**: JetBrains Mono（等幅フォント）

## 注意事項

### モック実装について
- 現在の実装はダミーデータを使用
- CRUD操作はメモリ内で完結（リロードでデータ消失）
- GL突合ロジックは簡易版（実際の業務ロジックは要カスタマイズ）

### ブラウザ対応
- Chrome 90+
- Firefox 88+
- Safari 14+
- Edge 90+

## ライセンス
MIT
