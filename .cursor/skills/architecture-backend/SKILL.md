---
name: architecture-backend
description: バックエンドのルート層/サービス層/データアクセス層の責務分離設計。新規APIエンドポイント追加、サーバー側リファクタ、ルート/サービス/リポジトリの設計時に使用
---

# バックエンド責務分離

## 🏗️ 3層アーキテクチャ

### ルート層（routes/）

- **HTTPリクエスト/レスポンス処理**: リクエスト受信、レスポンス返却
- **バリデーション**: Zodスキーマによる入力値検証
- **エラーハンドリング**: HTTPエラーレスポンスの生成
- **認証チェック**: ミドルウェアによる認証・認可確認

### サービス層（services/）

- **ビジネスロジック**: ドメイン固有の処理、計算、判定
- **トランザクション管理**: 複数テーブル更新時の一貫性保証
- **複数リポジトリの協調**: 関連データの整合性を保った操作
- **外部API連携**: 他システムとの通信処理

### データアクセス層（storage/）

- **データベース操作**: CRUD操作の実装
- **Drizzle ORMクエリ**: 型安全なクエリ実行
- **型安全なデータ取得**: スキーマから型を自動生成
- **クエリ最適化**: インデックス活用、N+1問題回避

## 🔄 依存関係

### 原則

- 各層は依存関係を一方向に保つ
- 上位層が下位層に依存

### 実装判断基準

#### ルート層に配置すべき処理

- HTTPリクエストの受信・レスポンス返却
- Zodスキーマによる入力値検証
- 認証・認可チェック
- HTTPエラーレスポンスの生成

#### サービス層に配置すべき処理

- ビジネスルールの実装
- 複数テーブルの整合性を保つ処理
- 外部APIとの連携
- 複雑な計算・判定ロジック

#### データアクセス層に配置すべき処理

- 単一テーブルのCRUD操作
- データベースクエリの最適化
- 型安全なデータ取得
- データ変換処理
