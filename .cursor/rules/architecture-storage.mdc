---
description: ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤è²¬å‹™åˆ†é›¢
globs: ["server/**/*.ts"]
alwaysApply: true
---

# ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

## ğŸ—ï¸ ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ è¨­è¨ˆ
```
server/storage/
â”œâ”€â”€ user/
â”‚   â”œâ”€â”€ userRepository.ts    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«æ“ä½œ
â”‚   â”œâ”€â”€ types.ts             # ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰å‹å®šç¾©
â”‚   â””â”€â”€ index.ts             # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé›†ç´„
â”œâ”€â”€ customer/
â”‚   â”œâ”€â”€ customerRepository.ts # é¡§å®¢ãƒ†ãƒ¼ãƒ–ãƒ«æ“ä½œ
â”‚   â”œâ”€â”€ types.ts             # é¡§å®¢å›ºæœ‰å‹å®šç¾©
â”‚   â””â”€â”€ index.ts             # ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé›†ç´„
â””â”€â”€ index.ts                 # å…¨ãƒªãƒã‚¸ãƒˆãƒªã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
```

### æ©Ÿèƒ½åˆ†é›¢ãƒ‘ã‚¿ãƒ¼ãƒ³
- **æ©Ÿèƒ½ã”ã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª**: user/, customer/, project/ãªã©
- **ãƒ†ãƒ¼ãƒ–ãƒ«å˜ä½**: 1ãƒ†ãƒ¼ãƒ–ãƒ« = 1ãƒªãƒã‚¸ãƒˆãƒª
- **è²¬å‹™åˆ†é›¢**: ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ã®ã¿ã‚’æ‹…å½“

### è¤‡é›‘ãªé–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«å¯¾å¿œæŒ‡é‡

#### 1å¯¾å¤šã®é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«
- **è¦ªãƒ†ãƒ¼ãƒ–ãƒ«**: ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†
- **å­ãƒ†ãƒ¼ãƒ–ãƒ«**: å°‚ç”¨ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆ
- **é–¢é€£æ“ä½œ**: è¦ªãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰å­ãƒªãƒã‚¸ãƒˆãƒªã‚’å‘¼ã³å‡ºã—

#### å¤šå¯¾å¤šã®é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«
- **ä¸­é–“ãƒ†ãƒ¼ãƒ–ãƒ«**: å°‚ç”¨ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆ
- **é–¢é€£ãƒ‡ãƒ¼ã‚¿å–å¾—**: JOINã‚¯ã‚¨ãƒªã§ä¸€æ‹¬å–å¾—
- **æ•´åˆæ€§ç®¡ç†**: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§é–¢é€£æ“ä½œã‚’å®Ÿè¡Œ

#### åˆ¤æ–­åŸºæº–
- **å˜ä¸€ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã¿æ“ä½œ** â†’ 1ãƒªãƒã‚¸ãƒˆãƒª
- **é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¤‡é›‘** â†’ é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã«ãƒªãƒã‚¸ãƒˆãƒªåˆ†å‰²
- **é–¢é€£ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ãŒé‡è¦** â†’ ã‚µãƒ¼ãƒ“ã‚¹å±¤ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†

### é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¤‡é›‘åº¦åŸºæº–

#### è¤‡é›‘ãªé–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã®å®šç¾©
- **3ã¤ä»¥ä¸Šã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒé–¢é€£** â†’ è¤‡é›‘
- **å¤šå¯¾å¤šã®é–¢ä¿‚ãŒå«ã¾ã‚Œã‚‹** â†’ è¤‡é›‘
- **JOINãŒ3ã¤ä»¥ä¸Š** â†’ è¤‡é›‘
- **ã‚µãƒ–ã‚¯ã‚¨ãƒªãŒ2ã¤ä»¥ä¸Š** â†’ è¤‡é›‘
- **æ›´æ–°å¯¾è±¡ãŒ3ãƒ†ãƒ¼ãƒ–ãƒ«ä»¥ä¸Š** â†’ è¤‡é›‘
- **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦** â†’ è¤‡é›‘

#### è¤‡é›‘åº¦åˆ¥å¯¾å¿œä¾‹
```typescript
// å˜ç´”ãªé–¢é€£ï¼ˆ1ãƒªãƒã‚¸ãƒˆãƒªã§å¯¾å¿œï¼‰
export class UserRepository {
  async findUserWithProfile(userId: string) {
    return await db.select()
      .from(users)
      .leftJoin(userProfiles, eq(users.id, userProfiles.userId))
      .where(eq(users.id, userId));
  }
}

// è¤‡é›‘ãªé–¢é€£ï¼ˆãƒªãƒã‚¸ãƒˆãƒªåˆ†å‰²ï¼‰
export class UserRepository {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±ã®ã¿
  async findById(id: string) {
    return await db.select().from(users).where(eq(users.id, id));
  }
}

export class UserProfileRepository {
  // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±
  async findByUserId(userId: string) {
    return await db.select().from(userProfiles).where(eq(userProfiles.userId, userId));
  }
}

export class UserRoleRepository {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«æƒ…å ±
  async findByUserId(userId: string) {
    return await db.select()
      .from(userRoles)
      .leftJoin(roles, eq(userRoles.roleId, roles.id))
      .where(eq(userRoles.userId, userId));
  }
}
```

## ğŸ”§ ãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¿ãƒ¼ãƒ³è¨­è¨ˆ

### ãƒªãƒã‚¸ãƒˆãƒªæ§‹é€ 
- **ãƒ•ã‚¡ã‚¤ãƒ«å‘½å**: `{æ©Ÿèƒ½å}Repository.ts`
- **ã‚¯ãƒ©ã‚¹å‘½å**: `{æ©Ÿèƒ½å}Repository`
- **ãƒ¡ã‚½ãƒƒãƒ‰å‘½å**: CRUDæ“ä½œã«å¿œã˜ãŸå‘½å

### å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³
```typescript
export class UserRepository {
  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆusersï¼‰ã‚’æ“ä½œã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒª
   */
  
  async findAll(): Promise<User[]> {
    return await db.select().from(users);
  }
  
  async findById(id: string): Promise<User | null> {
    const result = await db.select().from(users).where(eq(users.id, id));
    return result[0] || null;
  }
  
  async create(data: InsertUser): Promise<User> {
    const result = await db.insert(users).values(data).returning();
    return result[0];
  }
}
```

## ğŸ“Š å‹å®šç¾©è¨­è¨ˆ

### å‹åˆ†é›¢ãƒ‘ã‚¿ãƒ¼ãƒ³
- **å…±é€šå‹**: `@shared/schema/{æ©Ÿèƒ½å}/types`ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
- **å›ºæœ‰å‹**: `types.ts`ã§æ©Ÿèƒ½å›ºæœ‰ã®å‹ã‚’å®šç¾©
- **ãƒªãƒã‚¸ãƒˆãƒªå‹**: ãƒ¡ã‚½ãƒƒãƒ‰ã®å¼•æ•°ãƒ»æˆ»ã‚Šå€¤å‹

### å‹å®šç¾©ä¾‹
```typescript
import { User, InsertUser } from '@shared/schema/user/types';

export interface UserFilter {
  status?: string;
  role?: string;
}

export interface UserSearchOptions {
  filter?: UserFilter;
  limit?: number;
  offset?: number;
}
```

## ğŸ”„ ä¾å­˜é–¢ä¿‚è¨­è¨ˆ

### ä¾å­˜é–¢ä¿‚ã®åŸå‰‡
- **ä¸Šä½å±¤ä¾å­˜**: ã‚µãƒ¼ãƒ“ã‚¹å±¤ã‹ã‚‰ãƒªãƒã‚¸ãƒˆãƒªå±¤ã‚’å‘¼ã³å‡ºã—
- **æ¨ªæ–­ä¾å­˜ç¦æ­¢**: ãƒªãƒã‚¸ãƒˆãƒªé–“ã®ç›´æ¥ä¾å­˜ã¯ç¦æ­¢
- **å…±é€šå‡¦ç†**: å…±é€šã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å‡¦ç†ã¯åŸºåº•ã‚¯ãƒ©ã‚¹ã§å®Ÿè£…

### ä¾å­˜é–¢ä¿‚ä¾‹
```typescript
// ã‚µãƒ¼ãƒ“ã‚¹å±¤ã‹ã‚‰ãƒªãƒã‚¸ãƒˆãƒªå±¤ã‚’å‘¼ã³å‡ºã—
export class UserService {
  constructor(private userRepository: UserRepository) {}
  
  async createUser(data: CreateUserData): Promise<User> {
    // ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
    const userData = this.validateUserData(data);
    
    // ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ã‚’å‘¼ã³å‡ºã—
    return await this.userRepository.create(userData);
  }
}
```

## ğŸ“ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¨­è¨ˆ

### JSDocã‚³ãƒ¡ãƒ³ãƒˆ
- **ã‚¯ãƒ©ã‚¹**: ã©ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ“ä½œã™ã‚‹ã‹ã‚’æ˜ç¢ºåŒ–
- **ãƒ¡ã‚½ãƒƒãƒ‰**: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€æˆ»ã‚Šå€¤ã€ä¾‹å¤–ã®èª¬æ˜
- **å‹**: ç”¨é€”ã¨åˆ¶ç´„ã®èª¬æ˜

### ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¾‹
```typescript
/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆusersï¼‰ã‚’æ“ä½œã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒª
 * 
 * @description ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®CRUDæ“ä½œã‚’æä¾›
 * @table users - ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±ãƒ†ãƒ¼ãƒ–ãƒ«
 */
export class UserRepository {
  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§æ¤œç´¢
   * 
   * @param id - ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
   * @returns ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯nullï¼‰
   * @throws DatabaseError - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼
   */
  async findById(id: string): Promise<User | null> {
    // å®Ÿè£…
  }
}
```