---
description: テーブル変更時の手順ルール
globs: ["server/**/*.ts", "shared/**/*.ts", "drizzle.config.ts"]
alwaysApply: true
---

# テーブル変更時の手順ルール

## 🚫 絶対禁止事項

### 絶対禁止
- **既存システムのテーブル変更**（publicスキーマのテーブル）
- **バックアップなしでのテーブル変更**
- **変更後の確認なしでの本番デプロイ**
- **Drizzle ORMのマイグレーション使用**（既存テーブルとの競合回避のため）

## 🔧 テーブル変更必須手順

### 必須変更前準備
- **バックアップ取得**: `npx tsx server/backup-app-tables.ts`実行必須
- **変更内容ドキュメント化**: 変更理由、内容、影響範囲を記録必須
- **テスト環境での事前確認**: 本番環境での変更前にテスト環境で確認必須

### 必須変更手順
1. **テーブル定義修正**: `shared/schema/{テーブル名}/tables.ts`でappスキーマ指定必須
2. **手動変更実行**: `server/modify-app-tables.ts`を編集して実行必須
3. **変更後確認**: `npx tsx server/verify-app-tables.ts`実行必須

### 必須変更対象
- **appスキーマのテーブルのみ**: 本システムで作成したテーブルのみ変更対象
- **既存システムテーブル除外**: publicスキーマのテーブルは絶対に変更禁止

## 🏗️ テーブル変更実装パターン

### 必須カラム追加パターン
```typescript
// modify-app-tables.ts
await pool.query(`
  ALTER TABLE app.{テーブル名} 
  ADD COLUMN {カラム名} {データ型}
`);
console.log('✅ {テーブル名}テーブルに{カラム名}カラムを追加');
```

### 必須カラム削除パターン
```typescript
// modify-app-tables.ts
await pool.query(`
  ALTER TABLE app.{テーブル名} 
  DROP COLUMN {カラム名}
`);
console.log('✅ {テーブル名}テーブルから{カラム名}カラムを削除');
```

### 必須カラム変更パターン
```typescript
// modify-app-tables.ts
await pool.query(`
  ALTER TABLE app.{テーブル名} 
  ALTER COLUMN {カラム名} TYPE {新しいデータ型}
`);
console.log('✅ {テーブル名}テーブルの{カラム名}カラムを{新しいデータ型}に変更');
```

## 📊 変更後必須確認

### 必須確認項目
- **テーブル構造**: カラム名、データ型、制約の確認必須
- **データ整合性**: 既存データの整合性確認必須
- **アプリケーション動作**: 関連するアプリケーション機能の動作確認必須

### 必須ロールバック準備
- **バックアップ保持**: 変更前のバックアップを保持必須
- **ロールバック手順**: 問題発生時の復元手順を準備必須
- **影響範囲把握**: 変更による影響範囲を事前に把握必須

## 🔒 セキュリティ必須実装

### 必須権限管理
- **最小権限原則**: テーブル変更に必要な最小限の権限のみ使用必須
- **監査ログ**: テーブル変更操作のログ記録必須
- **承認プロセス**: 重要なテーブル変更は承認プロセス必須

### 必須データ保護
- **機密データ**: 機密データを含むテーブルの変更時は特別な注意必須
- **個人情報**: 個人情報を含むカラムの変更時は法的要件遵守必須
- **データマスキング**: テスト環境でのデータマスキング必須

## 📋 変更管理必須実装

### 必須バージョン管理
- **変更履歴**: 全てのテーブル変更を履歴として記録必須
- **スキーマバージョン**: スキーマのバージョン管理必須
- **変更承認**: 重要な変更は承認プロセス必須

### 必須ドキュメント化
- **変更理由**: テーブル変更の理由を明確に記録必須
- **影響範囲**: 変更による影響範囲を詳細に記録必須
- **復元手順**: 問題発生時の復元手順を文書化必須