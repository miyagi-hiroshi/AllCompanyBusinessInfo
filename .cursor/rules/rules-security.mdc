---
description: セキュリティ必須ルール（最優先）
globs: ["**/*.ts", "**/*.tsx", "server/**/*.ts", "client/**/*.tsx"]
alwaysApply: true
priority: 1
---

# セキュリティ必須ルール

## 🚨 絶対禁止事項

### 絶対禁止
- **ハードコードされた秘密鍵・パスワード**
- **未検証のユーザー入力の直接使用**
- **機密情報のログ出力**
- **未検証のファイルアップロード**
- **SQLインジェクション脆弱性のあるクエリ**

## 🔒 必須実装事項

### 必須セキュリティ対策
- **バリデーション**: 入力値のバリデーションを徹底
- **機密情報**: 環境変数で管理
- **SQLインジェクション**: 対策を実施
- **セキュリティミドルウェア**: Helmet、レート制限、CSRF保護、入力値サニタイゼーション、ファイルアップロードセキュリティを実装

### 必須セキュリティチェック
- **新機能開発時**: 必ずセキュリティチェックリストを確認

### 必須セキュリティ機能
- **セキュリティミドルウェア**: 使用必須
- **ファイルアップロードセキュリティ**: 使用必須
- **ログサニタイゼーション**: 使用必須

### 必須CSRF保護
- **CSRFトークン**: `/api/auth/csrf-token`エンドポイントの実装必須
- **検証**: 全POST/PUT/DELETEリクエストで検証必須


### 必須レート制限
- **一般API**: 1分100回制限必須
- **ログインAPI**: 15分5回制限必須
- **ファイルアップロード**: 1分10回制限必須

### 必須ファイル検証
- **危険な拡張子ブロック**: .exe、.bat、.sh、.php、.js、.html、.zip、.lnk等の実行可能・スクリプト・圧縮ファイルをブロック必須
- **MIMEタイプ検証**: `file-type`ライブラリによる検証必須
- **ファイルサイズ制限**: 以下の制限を設定必須
  - **画像ファイル**: 5MB以下
  - **文書ファイル**: 10MB以下
  - **CSVファイル**: 50MB以下
  - **証明書ファイル**: 2MB以下

### 必須サニタイゼーション
- **ログデータ**: 機密情報を`[REDACTED]`に置換必須
- **ユーザー入力**: 入力値サニタイゼーション必須
- **HTML出力**: HTMLサニタイゼーション必須
- **ファイル名**: パストラバーサル攻撃防止、危険文字除去、255文字制限必須

### 必須ログ設計
- **構造化ログ**: JSON形式での構造化ログ出力必須
- **ログレベル**: 以下の使い分け必須
  - **ERROR**: システムエラー、例外発生時
  - **WARN**: 警告、異常だが処理継続可能
  - **INFO**: 重要な処理の開始・終了
  - **DEBUG**: デバッグ情報（本番環境では出力しない）
- **コンテキスト情報**: リクエストID、ユーザーID等の追跡情報必須
- **ログ集約**: ログの集約・分析ツールの活用必須

### 必須セキュリティヘッダー
- **CSP**: Content Security Policy設定必須
- **HSTS**: HTTP Strict Transport Security設定必須
- **X-Frame-Options**: クリックジャッキング対策必須
- **X-Content-Type-Options**: MIMEタイプスニッフィング対策必須