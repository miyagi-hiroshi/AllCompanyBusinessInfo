---
description: データベース必須ルール
globs: ["server/**/*.ts", "shared/schema/**/*.ts", "drizzle.config.ts"]
alwaysApply: true
---

# データベース必須ルール

## 🚫 絶対禁止事項

### 絶対禁止
- **生SQLの直接使用**
- **型安全性の無視**
- **トランザクション管理の不備**
- **外部キー制約の未設定**
- **CASCADE DELETEの使用**

## 🔧 データベース操作必須実装

### 必須ORM使用
- **Drizzle ORM**: データベース操作はDrizzle ORMを使用必須
- **型安全性**: 厳密な型定義とZodスキーマ必須
- **トランザクション**: 複数操作はトランザクション内で実行必須

### 必須接続管理
- **接続プール**: 最小5、最大20の接続プールサイズ設定必須
- **タイムアウト**: 接続タイムアウト30秒、クエリタイムアウト60秒設定必須

## 🏗️ データベース制約必須実装

### 必須制約設定
- **外部キー制約**: 全関連テーブルで外部キー制約設定必須
- **NOT NULL制約**: 以下のフィールドに設定必須
  - **主キー**: id、uuid等の識別子
  - **必須データ**: name、email、createdAt等の必須情報
  - **外部キー**: 関連テーブルを参照するフィールド
  - **ビジネスキー**: コード、ステータス等の業務上必須フィールド
- **CASCADE DELETE**: 使用禁止


## 📊 データ整合性必須実装

### 必須データ検証
- **入力値**: Zodスキーマによる厳密な検証必須
- **型変換**: 適切な型変換処理必須

## 📅 日付・時刻必須実装

### 必須データベース保存
- **タイムゾーン情報**: タイムゾーン情報付きtimestamp（withTimezone: true）で保存必須
- **日付登録**: 日本時間のままISO形式で送信、UTC変換を避ける必須

### 必須スケジュール実行
- **クロン処理**: Asia/Tokyoタイムゾーンでスケジュール実行必須
- **日付範囲処理**: 開始日は00:00:00、終了日は23:59:59で設定必須

### 必須タイムゾーン処理
- **タイムゾーン変換**: UTC+9時間の手動計算で確実な変換必須
- **日付文字列変換**: タイムゾーン問題を回避する独自実装必須
- **ヘルパー関数**: 一貫した変換処理を行うヘルパー関数の活用必須